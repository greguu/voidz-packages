# Template file for 'z3'
pkgname=z3
version=4.15.4
revision=2
build_style=configure
configure_args="--prefix=/usr -g --python $(vopt_if ocaml --ml) --staticlib --single-threaded"
make_build_args="-C build all examples"
make_install_args="-C build install"
hostmakedepends="python3 which $(vopt_if ocaml 'ocaml ocaml-findlib')"
makedepends="libgomp-devel gmp-devel $(vopt_if ocaml 'ocaml-zarith ncurses-devel')"
depends="libz3 python3 python3-setuptools"
short_desc="Z3 theorem prover and SMT solver (command line + Python3 module)"
maintainer="Leah Neukirchen <leah@vuxu.org>"
license="MIT"
homepage="https://github.com/Z3Prover/z3"
distfiles="https://github.com/Z3Prover/z3/archive/z3-${version}.tar.gz"
checksum=dae526252cb0585c8c863292ebec84cace4901a014b190a73f14087dd08d252b

build_options="ocaml"
desc_option_ocaml="Enable support for OCaml bindings"

subpackages="$(vopt_if ocaml z3-ocaml) libz3 z3-devel"

if [ -z "$CROSS_BUILD" ]; then
	case "$XBPS_TARGET_MACHINE" in
		x86_64*|aarch64*|riscv64*) build_options_default="ocaml"
	esac
fi

do_check() {
	make ${MAKEJOBS} -C build test
	./build/test-z3 /a
}

pre_configure() {
	# 1. Neutralize the hardware rounding mode calls that crash the build.
	# Since there is no FPU, these constants don't exist in your fenv.h.
	sed -i 's/fesetround(RM)/((void)0)/g' src/util/hwf.cpp
	sed -i 's/fegetround()/0/g' src/util/hwf.cpp

	# 2. Force the compiler to bypass FENV logic.
	# We also set -D_GNU_SOURCE to ensure standard types are mapped correctly.
	export CXXFLAGS="${CXXFLAGS} -DHAS_FENV=0 -D_GNU_SOURCE"
	
	# 3. For ARMv5 soft-float, we ensure the build doesn't try to use 
	# SSE or NEON detection logic.
	export CFLAGS="${CFLAGS} -D_GNU_SOURCE"
}

do_configure() {
	# Z3's gnu-configure style actually prefers running their python script.
	python3 scripts/mk_make.py ${configure_args}
}

do_build() {
	make -C build ${make_build_args}
}

do_install() {
	make -C build DESTDIR=${DESTDIR} install
}

post_install() {
	vbin build/z3_tptp
	vbin build/maxsat
	if [ "$build_option_ocaml" ]; then
		vmkdir usr/lib/ocaml/Z3/stublibs
		mv ${DESTDIR}/usr/lib/ocaml/Z3/dllz3ml.so ${DESTDIR}/usr/lib/ocaml/Z3/stublibs
	fi
	vlicense LICENSE.txt
}

z3-ocaml_package() {
	short_desc="Z3 theorem prover and SMT solver (OCaml bindings)"
	depends="z3>=${version}_${revision}"
	pkg_install() {
		vmove usr/lib/ocaml
	}
}

libz3_package() {
	short_desc+=" - runtime library"
	pkg_install() {
		vmove usr/lib/libz3.so
	}
}

z3-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
	}
}
